name: Build

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - master

concurrency:
  group: build-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build extension
        run: pnpm run build

      - name: Create zip
        run: |
          mv dist smartkey
          zip -r smartkey.zip smartkey

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: smartkey-${{ github.head_ref || github.ref_name }}
          path: smartkey.zip
          overwrite: true

      - name: Find existing comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- build-artifact-comment -->'

      - name: Create or update comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- build-artifact-comment -->
            ## Build Artifact

            Download the latest build: [smartkey.zip](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/smartkey-${{ github.head_ref }}.zip)

            **Branch:** `${{ github.head_ref }}`
            **Commit:** ${{ github.event.pull_request.head.sha }}
            **Updated:** ${{ github.event.pull_request.updated_at }}
